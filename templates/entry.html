<html>
  <head>
    <title>Submit a form</title>
    <link rel="stylesheet" type="text/css" href="/static/style.css">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  </head>
    <script>
        var output;

        function logout() {
            var out = window.location.href.replace(/:\/\//, '://:out@');
            window.location.reload(true);
            jQuery.get(out).error(function() {
                window.location = "/";
            });
        }

        function doRadioButton(cb) {
            var splits = cb.name.split("_");
            var swapped =  splits[1] + "_" + splits[0];
            var o_cb = document.getElementsByName(swapped)[0];
            if (cb.checked == true) {
                o_cb.disabled = true;
                o_cb.checked = false;
            } else {
                o_cb.disabled = false;
                o_cb.checked = true;
            }
        }

        function onCBClick(cb) {
            validate(cb);
        }

        function redrawCalculations() {
            // set UI objects
            var cb = document.getElementById("showCalculations");
            if (cb.checked == true) {
                $("#calculationsTable tr").remove();
                if (output) {
                    var table = document.getElementById("calculationsTable");
                    for (ii = 0; ii < output.length; ii++) {
                        var row = table.insertRow(ii);
                        var cell = row.insertCell(0);
                        cell.innerHTML = output[ii];
                    }
                }
            }
        }

        function onCCBClick(cb) {
            if (cb.checked == true) {
                $(".calculations").show();
                redrawCalculations();
            } else {
                $(".calculations").hide();
            }
        }

        function onButtonClick(button) {
            location.reload();
        }

        function validate(cb_changed) {
            console.log(cb_changed.name + ", " + cb_changed.checked);
            var cb_splits = cb_changed.name.split("_");
            var cb_swapped =  cb_splits[1] + "_" + cb_splits[0];
            var o_cb_changed = document.getElementsByName(cb_swapped)[0];
            if (cb_changed.checked == true) {
                o_cb_changed.disabled = true;
                o_cb_changed.checked = false;
            } else {
                o_cb_changed.disabled = false;
                o_cb_changed.checked = true;
                cb_changed.disabled = true;
                cb_changed.checked = false;
            }
            // Gather list of checked checkboxes - combos
            var inputs = document.getElementsByTagName("input");
            var cbchecked = [];
            for (ii = 0; ii < inputs.length; ii++) {
                if(inputs[ii].type == "checkbox") {
                    if (inputs[ii].name == "Req3_Req2") {
                        console.log(cb_changed.name + ", " + cb_changed.checked);
                    }
                    if (inputs[ii].name != 'showCalculations' &&
                            inputs[ii].name != "refresh" &&
                            inputs[ii].name != "submit") {
                        if (inputs[ii].checked) {
                            cbchecked.push(inputs[ii]);
                        }
                    }
                }
            }
            // build output/prioritized list of reqs
            output = new Array();
            // for each req combo
            for (ii = 0; ii < cbchecked.length; ii++) {
                // get the checked checkbox -combo
                console.log(cbchecked[ii].name);
                // split the reqs
                var splits = cbchecked[ii].name.split("_");
                var i_item = splits[1];
                var o_item = splits[0];
                // if req is first get inside, else continue
                if (cbchecked[ii].name.endsWith(i_item)) {
                    // if req already in list
                    if (output.indexOf(i_item) >= 0) {
                        // if other req is also in list
                        if (output.indexOf(o_item) >= 0) {
                            // check for both already in list
                            var i_idx = output.indexOf(i_item);
                            var o_idx = output.indexOf(o_item);
                            if (i_idx > o_idx) {
                                //swap
                                output[i_idx] = o_item;
                                output[o_idx] = i_item;
                            }
                        } else {
                            //second item is not in list - so add
                            output.push(o_item);
                        }
                    } else {
                        // add the first requirement
                        output.push(i_item)
                        // check for other req to be already in list
                        if (output.indexOf(o_item) >= 0) {
                            // check for both already in list
                            var i_idx = output.indexOf(i_item);
                            var o_idx = output.indexOf(o_item);
                            if (i_idx > o_idx) {
                                //swap
                                output[i_idx] = o_item;
                                output[o_idx] = i_item;
                            }
                        } else {
                            //second item is not in list - so add
                            output.push(o_item);
                        }
                    }
                }
            }
            for (ii = 0; ii < output.length; ii++) {
                console.log(output[ii]);
            }
            redrawCalculations();
            // given list of requiremetns for project
            var reqs = "{{ project.requirements }}"
            // get total num of reqs
            var num_reqs = reqs.split(',').length;
            // check if num reqs and the checked check-boxes combo are same
            console.log(cbchecked.length + ", " + num_reqs * 2);

            var table = document.getElementById("theTable");
            for (col = 1; col < num_reqs; col++) {
                var weight_col = 0;
                for (row = 1; row < num_reqs + 3; row++) {
                    var cl = table.rows[row].cells[col];
                    if (cl) {
                        var ccl = cl.children[0];
                        if (ccl && ccl.type == "checkbox") {
                            var cb1 = ccl.name;
                            var cb = document.getElementById(cb1);
                            if (cb.checked) weight_col++;
                        }
                    }
                }
                ccl.innerHTML = weight_col;
            }

            var total = (num_reqs > 2) ? (num_reqs - 1) * (num_reqs - 2) : 2;
            if (cbchecked.length == total) {
                // Enable only if passes validation - test for loops!
                document.getElementById("submit").disabled = false;
            } else {
                document.getElementById("submit").disabled = true;
            }
            return true;
        }
   </script>
  <nav class="navbar navbar-inverse navbar-static-top" >
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="javascript:window.history.back()">Back</a>
          <p class="navbar-text">{{ current_user }}</p>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li><a href="/api/v1/about_page"><span class="glyphicon glyphicon-lamp"></span>About</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="javascript:logout()"><span class="glyphicon glyphicon-log-out"></span>Re-Login-As</a></li>
            </ul>
        </div>
      </div>
  </nav>
  <body>
    <div id="container">
      <div class="pagetitle">
        <table class="table">
            <TR>
                <td>
                    <button id="refresh" name="refresh" class="btn btn-primary" onclick="onButtonClick(this);"><span class="glyphicon glyphicon-refresh"></span>Project:</button>
                    <label>{{ project.projectId }}</label>
                </td>
            </TR>
            <tr>
                <td>
                    <label name="userId">User: {{ userId }}</label>
                </td>
            </tr>
           {% if date is defined %}
                <tr>
                    <td>
                        <label name="date">Date: {{ date.strftime("%Y-%m-%d% %H:%M:%S.%f") }} </label>
                    </td>
                </tr>
            {% endif %}
        </table>
      </div>
      <div id="main">
          <form method="post" action="{{ url_for('submitted_entry', projectId=project.projectId ) }}">
            <table id="theTable" class="table table-striped">
                <TR>
                    <th></th>
                    {% for item in project.requirements %}
                        <th style="text-align: center"> {{ item }} </th>
                    {% endfor %}
                </TR>
                {% for item in project.requirements %}
                    <TR>
                        <td align="left"> {{ item }} </td>
                        {% for item1 in project.requirements %}
                            {%  if item == item1 %}
                                <td align="center"> x </td>
                            {%  else %}
                                {% set cbname = item + "_" + item1 %}
                                <td style="text-align: center;">
                                    {% if requirements is defined %}
                                        {% if cbname in requirements %}
                                            <input id = {{  cbname }} type="checkbox" name={{ cbname }} onclick="onCBClick(this);" checked>
                                        {% else %}
                                            <input id = {{  cbname }} type="checkbox" name={{ cbname }} onclick="onCBClick(this);" >
                                        {% endif %}
                                    {% else %}
                                        <input id = {{  cbname }} type="checkbox" name={{ cbname }} onclick="onCBClick(this);" >
                                    {% endif %}
                                </td>
                            {%  endif %}
                        {% endfor %}
                    </TR>
                {% endfor %}
                <tr>
                    <td>
                       <label>Weights</label>
                    </td>
                    {% for item in project.requirements %}
                    <td align="center">
                        <label>x</label>
                    </td>
                    {% endfor %}
                </tr>
                <tr>
                    <td>
                       <input name="submit" id="submit" type="submit" disabled>
                    </td>
                </tr>
            </table>
          </form>
          <label>Show Calculations:</label>
            <input type="checkbox" id="showCalculations" name="showCalculations" onclick="onCCBClick(this);" unchecked>
            <div class="calculations" style="display:none">
                <table id="calculationsTable" class="table">
                </table>
            </div>
      </div>
    </div>
  </body>
</html>
