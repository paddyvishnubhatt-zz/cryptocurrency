<html>
  <head>
    <title>Submit a form</title>
    <link rel="stylesheet" type="text/css" href="/static/style.css">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  </head>
    <script>
        function logout() {
            var out = window.location.href.replace(/:\/\//, '://:out@');
            window.location.reload(true);
            jQuery.get(out).error(function() {
                window.location = "/";
            });
        }

        function onCBClick(cb) {
            console.log(cb.name);
            var splits = cb.name.split("_");
            var swapped =  splits[1] + "_" + splits[0];
            var o_cb = document.getElementsByName(swapped)[0];
            if (cb.checked == true) {
                o_cb.disabled = true;
                o_cb.checked = false;
            } else {
                o_cb.disabled = false;
                o_cb.checked = true;
            }
            validate()
        }

        function onCCBClick(cb) {
            if (cb.checked == true) {
                $(".calculations").show();
            } else {
                $(".calculations").hide();
            }
        }

        function validate() {
            // given list of requiremetns for project
            var reqs = "{{ project.requirements }}"
            // get total num of reqs
            var num_reqs = reqs.split(',').length;
            // Gather list of checked checkboxes - combos
            var inputs = document.getElementsByTagName("input");
            var cbchecked = [];
            for (ii = 0; ii < inputs.length; ii++) {
                if(inputs[ii].type == "checkbox") {
                    if (inputs[ii].name != 'showCalculations') {
                        if (inputs[ii].checked) {
                            cbchecked.push(inputs[ii]);
                        }
                    }
                }
            }
            // check if num reqs and the checked check-boxes combo are same
            console.log(cbchecked.length + ", " + num_reqs);
            // build output/prioritized list of reqs
            // TBD - figure out how to catch and reject loops
            var output = new Array();
            // for each req combo
            for (ii = 0; ii < cbchecked.length; ii++) {
                // get the checked checkbox -combo
                console.log(cbchecked[ii].name);
                // split the reqs
                var splits = cbchecked[ii].name.split("_");
                var i_item = splits[0];
                var o_item = splits[1];
                // if req is first get inside, else continue
                if (cbchecked[ii].name.startsWith(i_item)) {
                    // if req already in list
                    if (output.indexOf(i_item) >= 0) {
                        // if other req is also in list
                        if (output.indexOf(o_item) >= 0) {
                            // check for both already in list
                            var i_idx = output.indexOf(i_item);
                            var o_idx = output.indexOf(o_item);
                            if (i_idx > o_idx) {
                                //swap
                                output[i_idx] = o_item;
                                output[o_idx] = i_item;
                            }
                        } else {
                            //second item is not in list - so add
                            output.push(o_item);
                        }
                    } else {
                        // add the first requirement
                        output.push(i_item)
                        // check for other req to be already in list
                        if (output.indexOf(o_item) >= 0) {
                            // check for both already in list
                            var i_idx = output.indexOf(i_item);
                            var o_idx = output.indexOf(o_item);
                            if (i_idx > o_idx) {
                                //swap
                                output[i_idx] = o_item;
                                output[o_idx] = i_item;
                            }
                        } else {
                            //second item is not in list - so add
                            output.push(o_item);
                        }
                    }
                }
            }
            for (ii = 0; ii < output.length; ii++) {
                console.log(output[ii]);
            }
            if (cbchecked.length == num_reqs) {
                // Enable only if passes validation - test for loops!
                document.getElementById("submit").disabled = false;
                // set UI objects
                var cb = document.getElementById("showCalculations");
                if (cb.checked == true) {
                    $("#calculationsTable tr").remove();
                    var table = document.getElementById("calculationsTable");
                    for (ii = 0; ii < output.length; ii++) {
                        var row = table.insertRow(ii);
                        var cell = row.insertCell(0);
                        cell.innerHTML = output[ii];
                    }
                }
            } else {
                document.getElementById("submit").disabled = true;
            }
        }
    </script>
  <nav class="navbar navbar-inverse navbar-static-top" >
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="javascript:window.history.back()">Back</a>
          <p class="navbar-text">{{ current_user }}</p>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li><a href="/api/v1/about_page"><span class="glyphicon glyphicon-lamp"></span>About</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="javascript:logout()"><span class="glyphicon glyphicon-log-out"></span>Re-Login-As</a></li>
            </ul>
        </div>
      </div>
  </nav>
  <body>
    <div id="container">
      <div class="pagetitle">
        <label>Project: {{ project.projectId }}</label>
        <br>
        <label name="userId">User: {{ userId }}</label>
        {% if date is defined %}
            <br>
            <label name="date">Date: {{ date.strftime("%Y-%m-%d% %H:%M:%S.%f") }} <label>
        {% endif %}
      </div>
      <div id="main">
          <form method="post" action="{{ url_for('submitted_entry', projectId=project.projectId ) }}">
            <table class="table table-striped">
                <TR>
                    <th></th>
                    {% for item in project.requirements %}
                        <th style="text-align: center"> {{ item }} </th>
                    {% endfor %}
                </TR>
                {% for item in project.requirements %}
                    <TR>
                        <td align="left"> {{ item }} </td>
                        {% for item1 in project.requirements %}
                            {%  if item == item1 %}
                                <td align="center"> x </td>
                            {%  else %}
                                {% set cbname = item + "_" + item1 %}
                                <td style="text-align: center;">
                                    {% if requirements is defined %}
                                        {% if cbname in requirements %}
                                            <input type="checkbox" name={{ cbname }} onclick="onCBClick(this);" checked>
                                        {% else %}
                                            <input type="checkbox" name={{ cbname }} onclick="onCBClick(this);" >
                                        {% endif %}
                                    {% else %}
                                        <input type="checkbox" name={{ cbname }} onclick="onCBClick(this);" >
                                    {% endif %}
                                </td>
                            {%  endif %}
                        {% endfor %}
                    </TR>
                {% endfor %}
            </table>
            <input id="submit" type="submit" disabled>
            <br>
            <br>
            <div class="calculations_stuff">
                Show Calculations:
                <input type="checkbox" id="showCalculations" name="showCalculations" onclick="onCCBClick(this);" unchecked>
                <br>
                <br>
                <div class="calculations" style="display:none">
                    <table id="calculationsTable" class="table">
                    </table>
                </div>
            </div>
          </form>
      </div>
    </div>
  </body>
</html>
