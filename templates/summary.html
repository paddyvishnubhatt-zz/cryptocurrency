<!DOCTYPE html>
<html lang="en">
<head>
    <title>Summary</title>
    <link rel="stylesheet" type="text/css" href="/static/style.css">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.9/js/bootstrap-dialog.min.js"></script>
    <script type="text/javascript" src="/static/common.js"></script>
    <script type="text/javascript" src="/static/jquery.hotkeys-0.7.9.min.js"></script>
    <script src="/static/tableHeadFixer.js"></script>
    <nav class="navbar navbar-inverse navbar-static-top" >
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="/"><span class="glyphicon glyphicon-home"/></a>
                <a class="navbar-brand" href="javascript:window.history.back()">Back</a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="/api/v1/about_page"><span class="glyphicon glyphicon-lamp"></span>About</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="javascript:popup('Notice', 'User Settings will be available in V2')"><span class="glyphicon glyphicon-user"></span>{{ current_user }}</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <style>
    </style>
</head>
<body>
<script>
    var filter = [];
    var blast = [];
    $(document).ready(function(){
        var table = $('#fixTable').tableHeadFixer( {
            left: 7,
            head:true,
            foot:true,
            'z-index':999
        });
        $(document).bind('keydown', 'ctrl+z', undo);
        var table = document.getElementById("fixTable");
        var thead = table.getElementsByTagName("thead")[0];
        thead.onclick = function (e) {
           e = e || window.event;
           var th = e.target || e.srcElement;  //assumes there are no other elements in the th
           console.log(th.innerHTML.trim() + ", " + th.cellIndex);
           onBlast(th);
        }
    });

    function undo() {
        // console.log("**** 1 " + blast);
        for (var vv = 0; vv < 2; vv++) {
            var idx = blast[blast.length - 1];
            // console.log("\t****  " + vv + ": " + idx  + ", " + blast);
            if (idx == "" || idx == NaN) {
                return;
            }
            $('th:nth-child(' + idx  + '), td:nth-child(' + idx  + ')').show();
            blast.pop();
        }
        // console.log("**** 2 " + blast);
    }

    function onBlast(th) {
        if (th.innerHTML.indexOf("Score") < 0) {
            return;
        }
        var idx =  th.cellIndex + 1;
        var idx1 = idx + 1;
        if (th.innerHTML.indexOf("Weighted") >= 0) {
            idx1 = idx - 1;
        }

        console.log(idx + ", " + idx1);
        $('th:nth-child(' + idx +  '), td:nth-child(' + idx +  ')').hide();
        $('th:nth-child(' + idx1 + '), td:nth-child(' + idx1 + ')').hide();

        blast.push(idx);
        blast.push(idx1);
    }

    function onCompareClick(cb) {
        console.log(cb.name);
        if (cb.checked) {
            filter.push(cb.name);
        } else {
            var idx = filter.indexOf(cb.name);
            filter.splice(idx, 1);
        }
    }

    function onRefresh() {
        console.log(filter);
        document.getElementById("filter").value = filter;
        return false;
    }

    function showCompares(displayFlag) {
        var cbs = getCbList();
        var spans = getSpans();
        if (displayFlag) {
            for (var ii = 0; ii < cbs.length; ii++) {
                cbs[ii].style.display = "inline"
            }
            for (var ii = 0; ii < spans.length; ii++) {
                spans[ii].style.display = "inline"
            }
            compareCBRow.style.display = "table-row";
            refresh.style.display = "inline";
        } else {
            for (var ii = 0; ii < cbs.length; ii++) {
                cbs[ii].style.display = "none"
            }
            for (var ii = 0; ii < spans.length; ii++) {
                spans[ii].style.display = "none"
            }
            compareCBRow.style.display = "none";
            refresh.style.display = "none";
            filter = [];
        }


    }
    function onCBClick(cb) {
        showCompares(cb.checked);
    }

    function getSpans() {
        var spans = [];
        var inputs = document.getElementsByTagName("span");
        for (ii = 0; ii < inputs.length; ii++) {
            if (inputs[ii].id.indexOf("spancbs") >= 0) {
                spans.push(inputs[ii]);
            }
        }
        return spans;
    }

    function getCbList() {
        var inputs = document.getElementsByTagName("input");
        var cbs = [];
        for (ii = 0; ii < inputs.length; ii++) {
            if(inputs[ii].type == "checkbox") {
                if (inputs[ii].name != 'compare') {
                    cbs.push(inputs[ii]);
                }
            }
        }
        return cbs;
    }

</script>
<div id="in" style="float:left; padding-left: 10px">
    Project: {{ project.projectId }}
    &nbsp;
    &nbsp;
    &nbsp;
    {% set project_status, percentage = get_project_status(project.projectId) %}
    {% if project_status == "Late" %}
        <span class="glyphicon glyphicon-exclamation-sign" style="color:red"></span>
    {% elif project_status == "Incomplete" %}
        <span class="glyphicon glyphicon-exclamation-sign" style="color:orange"></span>
    {% else %}
        <span class="glyphicon glyphicon-ok-sign" style="color:green"></span>
    {% endif %}
    &nbsp;
    &nbsp;
    &nbsp;
    {{ percentage }}
    &nbsp;
    %

</div>
<div id="out" style="float:right; padding-right: 100px">
    <form method="post" action="{{ url_for('filter_vendors', projectId=project.projectId ) }}" onsubmit="return onRefresh()">
        <input type="text" name="filter" id="filter" style="display:none">
        {% if filteredVendorIds is defined %}
        {% else %}
            <label>Compare</label>
            <input id = "compare" type="checkbox" name="compare" onclick="onCBClick(this);">
            &nbsp;
            &nbsp;
            <input type="submit" class="btn btn-default" name="refresh" id="refresh" style="display: none" value="Compare" >
        {% endif %}
            &nbsp;
            &nbsp;
        {% set urlx = "/api/v1/show_entrys_given_project/" + project.projectId | urlencode %}
        <a href={{ urlx }}>
            <label>Entrys
                <span name="entryspan" class="glyphicon glyphicon-chevron-right"></span>
            </label>
        </a>
    </form>
</div>
<div id="parent" style="height: 90%; width: 90%">
    {% set vendorIds = project.vendorIds %}
    {% if filteredVendorIds is defined %}
        {% set vendorIds = filteredVendorIds %}
    {% endif %}
    {% set cs = vendorIds | length * 2 %}
    <table id="fixTable" class="table table-condensed" >
        <thead>
        <tr>
            <th colspan="7" style="text-align: center">Objectives</th>
            <th colspan="{{ cs }}" style="text-align: center">Evaluation Criteria</th>
            <div id="compareCB" style="display:inline">
                <tr id="compareCBRow" style="display: none;">
                {% for ii in range(7) %}
                     <td></td>
                {% endfor %}
                {% for vendor in vendorIds %}
                    <th colspan="2" style="text-align: center">
                        <span id="spancbs_" + {{ vendor }} style="display:none">Compare</span>
                        <input id="cbs" type="checkbox" name={{ vendor }} style="display:none" onclick="onCompareClick(this);">
                    </th>
                {% endfor %}
                </tr>
            </div>
        </tr>
        <tr>
            <th>ID</th>
            <th>Description</th>
            <th>Weight</th>
            <th>Criteria ID</th>
            <th>Criterion</th>
            <th>Criteria</th>
            <th>Criteria Weight</th>
            {% for vendor in vendorIds %}
                <th style="border-left:1px solid;">
                    {{ vendor }} Score
                </th>
                <th>
                    {{ vendor }} Weighted Score
                </th>
            {% endfor %}
        </tr>
        </thead>
        <tbody>
        {% if bos_db is defined %}
            {% for bo in bos_db %}
                <tr>
                    <td>
                        {{ bo.objectiveId }}
                    </td>
                    <td>
                        {{ bo.description }}
                    </td>
                    <td>
                        {{ bo.weight }}
                    </td>
                    {% set count = [0] %}
                    {% for ec in bo.evaluation_criteria %}
                        {% if count > [0] %}
                            <tr>
                            {% for ii in range(3) %}
                                <td></td>
                            {% endfor %}
                        {% endif %}
                    <td>
                        {{ ec.evaluation_criterionId }}
                    </td>
                    <td>
                        {% set ldata = criteria_to_users_map.get(ec.evaluation_criterion | replace(" ", "^"))  %}
                        {% if ldata %}
                            {% set udata = [""] %}
                            {% for idata in ldata %}
                                {% set tstr = '%15s  (%3.2f)'| format(idata.get("userId"), idata.get("weight") | float) + "<br>"%}
                                {% if udata.append(udata.pop() + tstr ) %}{% endif %}
                            {% endfor %}
                            {% set  href = 'javascript:popup("Users & Weights", "' + udata[0]  + '")' %}
                        {% else %}
                            {% set href = "#" %}
                        {% endif %}
                        <a href="{{ href }}" class="btn btn-default"> {{ ec.evaluation_criterion }}</a>
                    </td>
                    <td>
                        {{ '%0.2f'| format(ec.calculations["criteria_percentage"]|float)  }}
                    </td>
                    <td>
                        {{ '%0.2f'| format(ec.calculations["criteria_weight"]|float) }}
                    </td>
                    {% for vendor in vendorIds %}
                        <td style="border-left:1px solid;">
                            {% set key = vendor + "_vendor_score" %}
                            {{ '%0.2f'| format(ec.calculations[key]|float) }}
                        </td>
                        <td>
                            {% set key = vendor + "_vendor_weighted_score" %}
                            {{ ec.calculations[key] }}
                        </td>
                    {% endfor %}
                        {% if count > [0] %}
                            </tr>
                        {% endif %}
                    {% if count.append(count.pop() + 1) %}{% endif %}
                    {% endfor %}
                </tr>
            {% endfor %}
            <tr>
            <td>Total</td>
            {% for ii in range(6) %}
                 <td></td>
            {% endfor %}
            {% for vendor in vendorIds %}
                 <td></td>
                 <td>
                     {{ '%0.2f'| format(vendor_sums[vendor]) | float }}
                    {% if top_vendor is defined %}
                        {% if vendor == top_vendor %}
                            (*)
                        {% endif %}
                    {% endif %}
                </td>
            {% endfor %}
            </tr>
        {% endif %}
        </tbody>
        <tfoot>
        <tr>
            <td colspan="{{ 7+cs }}" >(*): Top vendor</td>
        </tr>
        </tfoot>
    </table>
</div>
</body>
</html>


